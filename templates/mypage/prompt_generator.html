{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸ì œ ê´€ë¦¬ - AI í•´ì„¤ ìƒì„±ê¸°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f7f4;
        }

        header {
            background-color: #2d6a4f;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .card h2 {
            color: #1b4332;
            margin: 0 0 20px 0;
            border-bottom: 2px solid #d8f3dc;
            padding-bottom: 10px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #1b4332;
            margin-bottom: 8px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #2d6a4f;
        }

        .btn-generate {
            background-color: #2d6a4f;
            color: white;
            padding: 12px 40px;
            border: 2px solid #2d6a4f;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            box-sizing: border-box;
        }

        .btn-generate:hover {
            background-color: #1b4332;
        }

        .btn-query {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s;
        }

        .btn-query.basic-book {
            background-color: #0077b6;
            color: white;
        }

        .btn-query.basic-book:hover {
            background-color: #005f8c;
        }

        .btn-query.tree-doctor {
            background-color: #9c27b0;
            color: white;
        }

        .btn-query.tree-doctor:hover {
            background-color: #7b1fa2;
        }

        .btn-query:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .response-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 25px;
        }

        @media (max-width: 900px) {
            .response-grid {
                grid-template-columns: 1fr;
            }
        }

        .response-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .response-card h3 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid;
        }

        .response-card.basic-book h3 {
            color: #0077b6;
            border-color: #caf0f8;
        }

        .response-card.tree-doctor h3 {
            color: #9c27b0;
            border-color: #f3e5f5;
        }

        .response-content {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: #666;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2d6a4f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .btn-save {
            display: inline-block;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s;
        }

        .btn-save.basic-book {
            background-color: #0077b6;
            color: white;
        }

        .btn-save.tree-doctor {
            background-color: #9c27b0;
            color: white;
        }

        .btn-copy {
            background-color: #ff9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn-copy:hover {
            background-color: #e68900;
        }

        .prompt-output {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap;
            font-family: 'Noto Sans KR', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            max-height: 280px;
            overflow-y: auto;
        }

        .question-info {
            background: #d8f3dc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .question-info strong {
            color: #1b4332;
        }

        .nav-link {
            color: white;
            text-decoration: none;
        }

        .nav-link:hover {
            color: #b7e4c7;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .action-buttons {
            margin-top: 0;
            padding-top: 0;
        }
    </style>
</head>

<body>
    <header>
        <a href="{% url 'main:index' %}" class="logo">ğŸŒ³ ë‚˜ë¬´ì˜ì‚¬ í•©ê²©ë°˜</a>
        <a href="{% url 'mypage:index' %}" class="nav-link">
            <i class="fas fa-arrow-left"></i> ë§ˆì´í˜ì´ì§€ë¡œ
        </a>
    </header>

    <div class="container">
        <div class="card">
            <h2 style="margin-bottom: 15px;"><i class="fas fa-cog" style="color: #ff9800;"></i> ë¬¸ì œ ê´€ë¦¬ - AI í•´ì„¤ ìƒì„±ê¸°</h2>

            <form method="POST">
                {% csrf_token %}
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <label for="round_number" style="font-weight: bold; white-space: nowrap;"><i class="fas fa-list-ol"></i> íšŒì°¨</label>
                    <select name="round_number" id="round_number" required style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; min-width: 120px;">
                        <option value="">-- ì„ íƒ --</option>
                        {% for exam in exams %}
                        <option value="{{ exam.round_number }}">ì œ{{ exam.round_number }}íšŒ</option>
                        {% endfor %}
                    </select>
                    <label for="question_number" style="font-weight: bold; white-space: nowrap;"><i class="fas fa-hashtag"></i> ë¬¸ì œë²ˆí˜¸</label>
                    <input type="number" name="question_number" id="question_number" min="1" max="140" placeholder="1~140" required style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; width: 100px;">
                    <button type="submit" class="btn-generate" style="padding: 8px 20px; font-size: 0.95rem;">
                        <i class="fas fa-magic"></i> í”„ë¡¬í”„íŠ¸ ìƒì„±
                    </button>
                </div>
            </form>
        </div>

        {% if generated_prompt %}
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #d8f3dc; padding-bottom: 10px;">
                <h2 style="margin: 0; border: none; padding: 0;"><i class="fas fa-file-alt" style="color: #2d6a4f;"></i> ìƒì„±ëœ í”„ë¡¬í”„íŠ¸</h2>
                {% if selected_question %}
                <div style="background: #d8f3dc; padding: 8px 15px; border-radius: 8px;">
                    <strong>ì„ íƒëœ ë¬¸ì œ:</strong> ì œ{{ selected_question.exam.round_number }}íšŒ {{ selected_question.subject.name }} {{ selected_question.number }}ë²ˆ
                    {% if selected_question.explanation %}
                    <span style="color: #2d6a4f; margin-left: 10px;"><i class="fas fa-check-circle"></i> ê¸°ì¡´ í•´ì„¤</span>
                    {% else %}
                    <span style="color: #e63946; margin-left: 10px;"><i class="fas fa-exclamation-circle"></i> í•´ì„¤ ì—†ìŒ</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <div style="display: flex; gap: 20px; align-items: flex-start;">
                <div class="prompt-output" id="prompt-text" style="flex: 1;">{{ generated_prompt }}</div>
                <div class="action-buttons" style="display: flex; flex-direction: column; gap: 10px; min-width: 200px;">
                    <button type="button" id="btn-ask-all" onclick="queryAll()" style="width: 100%; text-align: center; padding: 12px 20px; background: linear-gradient(135deg, #2d6a4f, #9c27b0); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        <i class="fas fa-bolt"></i> ëª¨ë‘ ì§ˆë¬¸
                    </button>
                    <button type="button" class="btn-query basic-book" id="btn-basic-book" onclick="queryAI('basic_book')" style="width: 100%; text-align: center; padding: 12px 20px;">
                        <i class="fas fa-book"></i> ê¸°ë³¸ì„œì— ì§ˆë¬¸
                    </button>
                    <button type="button" class="btn-query tree-doctor" id="btn-tree-doctor" onclick="queryAI('tree_doctor')" style="width: 100%; text-align: center; padding: 12px 20px;">
                        <i class="fas fa-tree"></i> ë‚˜ë¬´ì£¼ì¹˜ì˜ì—ê²Œ ì§ˆë¬¸
                    </button>
                    <button type="button" class="btn-copy" onclick="copyText('prompt-text')" style="width: 100%; text-align: center; padding: 12px 20px; margin-left: 0;">
                        <i class="fas fa-copy"></i> í”„ë¡¬í”„íŠ¸ ë³µì‚¬
                    </button>
                </div>
            </div>
        </div>

        <div class="response-grid">
            <div class="response-card basic-book">
                <h3><i class="fas fa-book"></i> ê¸°ë³¸ì„œ AI ë‹µë³€</h3>
                <div class="response-content" id="basic-book-text">
                    <div class="loading-state" id="loading-basic-book" style="display: none;">
                        <div class="spinner"></div>
                        <span>ê¸°ë³¸ì„œì—ì„œ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</span>
                    </div>
                    <div id="content-basic-book">ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê¸°ë³¸ì„œì— ì§ˆë¬¸í•˜ì„¸ìš”.</div>
                </div>
                <button type="button" class="btn-copy" onclick="copyText('content-basic-book')" style="display: none;"
                    id="copy-basic-book">
                    <i class="fas fa-copy"></i> ë³µì‚¬
                </button>
                <button type="button" class="btn-save basic-book" onclick="saveExplanation('basic_book')"
                    style="display: none;" id="save-basic-book">
                    <i class="fas fa-database"></i> DBì— ì €ì¥
                </button>
                <div class="success-msg" id="msg-basic-book"></div>
            </div>

            <div class="response-card tree-doctor">
                <h3><i class="fas fa-tree"></i> ë‚˜ë¬´ì£¼ì¹˜ì˜ AI ë‹µë³€</h3>
                <div class="response-content" id="tree-doctor-text">
                    <div class="loading-state" id="loading-tree-doctor" style="display: none;">
                        <div class="spinner"></div>
                        <span>ë‚˜ë¬´ì£¼ì¹˜ì˜ê°€ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</span>
                    </div>
                    <div id="content-tree-doctor">ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë‚˜ë¬´ì£¼ì¹˜ì˜ì—ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”.</div>
                </div>
                <button type="button" class="btn-copy" onclick="copyText('content-tree-doctor')" style="display: none;"
                    id="copy-tree-doctor">
                    <i class="fas fa-copy"></i> ë³µì‚¬
                </button>
                <button type="button" class="btn-save tree-doctor" onclick="saveExplanation('tree_doctor')"
                    style="display: none;" id="save-tree-doctor">
                    <i class="fas fa-database"></i> DBì— ì €ì¥
                </button>
                <div class="success-msg" id="msg-tree-doctor"></div>
            </div>
        </div>

        <!-- AI Studio ì¸í¬ê·¸ë˜í”½ í”„ë¡¬í”„íŠ¸ -->
        <div class="card" style="margin-top: 25px;">
            <h2><i class="fas fa-image" style="color: #e91e63;"></i> AI Studio ì¸í¬ê·¸ë˜í”½ í”„ë¡¬í”„íŠ¸</h2>
            <p style="color: #666; margin-bottom: 15px;">ì•„ë˜ í”„ë¡¬í”„íŠ¸ë¥¼ AI Studioì— ë³µì‚¬í•˜ì—¬ ì¸í¬ê·¸ë˜í”½ì„ ìƒì„±í•˜ì„¸ìš”. (AI ë‹µë³€ ìƒì„± í›„ ìë™ ê°±ì‹ )</p>
            <div class="prompt-output" id="infographic-prompt" style="background: #fff3e0;">ëŒ€ê¸° ì¤‘... ë¨¼ì € AI ë‹µë³€ì„ ìƒì„±í•˜ì„¸ìš”.
            </div>
            <button type="button" class="btn-copy" onclick="copyText('infographic-prompt')"
                style="background: #e91e63;">
                <i class="fas fa-copy"></i> ì¸í¬ê·¸ë˜í”½ í”„ë¡¬í”„íŠ¸ ë³µì‚¬
            </button>
        </div>
        {% endif %}
    </div>

    <script>
        const csrfToken = '{{ csrf_token }}';
        const queryUrl = '{% url "mypage:query_ai_api" %}';
        const saveUrl = '{% url "mypage:prompt_generator" %}';
        const questionId = '{{ selected_question.id|default:"" }}';
        const subjectName = '{{ selected_question.subject.name|default:"" }}';
        const selectedRound = '{{ selected_question.exam.round_number|default:"" }}';
        const selectedNumber = '{{ selected_question.number|default:"" }}';

        // Set form values on page load
        document.addEventListener('DOMContentLoaded', function () {
            if (selectedRound) {
                document.getElementById('round_number').value = selectedRound;
            }
            if (selectedNumber) {
                document.getElementById('question_number').value = selectedNumber;
            }
            
            // Auto query all when prompt is generated
            const promptText = document.getElementById('prompt-text');
            if (promptText && promptText.innerText.trim() !== '') {
                setTimeout(() => queryAll(), 500);
            }
        });

        // Question data for infographic prompt
        const questionData = {
            subject: '{{ selected_question.subject.name|default:"" }}',
            round: '{{ selected_question.exam.round_number|default:"" }}',
            number: '{{ selected_question.number|default:"" }}',
            content: `{{ selected_question.content|default:""|escapejs }}`,
            choice1: `{{ selected_question.choice1|default:""|escapejs }}`,
            choice2: `{{ selected_question.choice2|default:""|escapejs }}`,
            choice3: `{{ selected_question.choice3|default:""|escapejs }}`,
            choice4: `{{ selected_question.choice4|default:""|escapejs }}`,
            choice5: `{{ selected_question.choice5|default:""|escapejs }}`
        };

        function updateInfographicPrompt(explanation) {
            const q = questionData;
            const prompt = `(${q.subject}) ${q.round}-${q.number}. ${q.content}
â‘  ${q.choice1}
â‘¡ ${q.choice2}
â‘¢ ${q.choice3}
â‘£ ${q.choice4}
â‘¤ ${q.choice5}

${explanation}

ìœ„ ë‚´ìš©ìœ¼ë¡œ ì¸í¬ê·¸ë˜í”½ì„ ë§Œë“¤ì–´ ì¤˜
ìš”êµ¬ì‚¬í•­ï¼š
ï¼‘ï¼‰ ï¼‘ï¼–ï¼šï¼™ ë¹„ìœ¨
ï¼’ï¼‰ í•œêµ­ì–´ í…ìŠ¤íŠ¸ í¬í•¨
ï¼“ï¼‰ ì „ë¬¸ì ì´ê³  êµìœ¡ì ì¸ ìŠ¤íƒ€ì¼
ï¼”ï¼‰ ë‚˜ë¬´ ë³‘í•´ ê´€ë ¨ ì‹œê° ìš”ì†Œ
ï¼•ï¼‰ ìµœìƒë‹¨ì¹¸ì€ "(${q.subject}) ${q.round}-${q.number}. ${q.content}" ì™¼ìª½ ì •ë ¬í•´`;

            document.getElementById('infographic-prompt').innerText = prompt;
        }

        function copyText(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
            });
        }

        function queryAll() {
            const btn = document.getElementById('btn-ask-all');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì§ˆë¬¸ ì¤‘...';
            
            // Call both queries
            queryAI('basic_book');
            queryAI('tree_doctor');
            
            // Re-enable button after 2 seconds
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-bolt"></i> ëª¨ë‘ ì§ˆë¬¸';
            }, 2000);
        }

        function queryAI(apiType) {
            const prompt = document.getElementById('prompt-text').innerText;
            const loadingId = apiType === 'basic_book' ? 'loading-basic-book' : 'loading-tree-doctor';
            const contentId = apiType === 'basic_book' ? 'content-basic-book' : 'content-tree-doctor';
            const btnId = apiType === 'basic_book' ? 'btn-basic-book' : 'btn-tree-doctor';
            const copyBtnId = apiType === 'basic_book' ? 'copy-basic-book' : 'copy-tree-doctor';
            const saveBtnId = apiType === 'basic_book' ? 'save-basic-book' : 'save-tree-doctor';

            // Show loading
            document.getElementById(loadingId).style.display = 'flex';
            document.getElementById(contentId).style.display = 'none';
            document.getElementById(btnId).disabled = true;
            document.getElementById(copyBtnId).style.display = 'none';
            document.getElementById(saveBtnId).style.display = 'none';

            const formData = new FormData();
            formData.append('api_type', apiType);
            formData.append('prompt', prompt);
            formData.append('subject_name', subjectName);
            formData.append('csrfmiddlewaretoken', csrfToken);

            fetch(queryUrl, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById(loadingId).style.display = 'none';
                    document.getElementById(contentId).style.display = 'block';
                    document.getElementById(btnId).disabled = false;

                    if (data.success) {
                        document.getElementById(contentId).innerText = data.response;
                        document.getElementById(copyBtnId).style.display = 'inline-block';
                        document.getElementById(saveBtnId).style.display = 'inline-block';
                        // Update infographic prompt with the AI response
                        updateInfographicPrompt(data.response);
                    } else {
                        document.getElementById(contentId).innerText = 'ì˜¤ë¥˜: ' + (data.error || 'Unknown error');
                    }
                })
                .catch(err => {
                    document.getElementById(loadingId).style.display = 'none';
                    document.getElementById(contentId).style.display = 'block';
                    document.getElementById(contentId).innerText = 'ì˜¤ë¥˜: ' + err;
                    document.getElementById(btnId).disabled = false;
                });
        }

        function saveExplanation(source) {
            if (!questionId) {
                alert('ë¬¸ì œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const contentId = source === 'basic_book' ? 'content-basic-book' : 'content-tree-doctor';
            const explanationText = document.getElementById(contentId).innerText;

            const formData = new FormData();
            formData.append('action', 'save_explanation');
            formData.append('question_id', questionId);
            formData.append('explanation_text', explanationText);
            formData.append('explanation_source', source);
            formData.append('csrfmiddlewaretoken', csrfToken);

            fetch(saveUrl, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    const msgId = 'msg-' + source.replace('_', '-');
                    const msgElement = document.getElementById(msgId);
                    msgElement.style.display = 'block';
                    msgElement.innerText = data.message;
                    if (data.success) {
                        msgElement.style.background = '#d4edda';
                        msgElement.style.color = '#155724';
                    } else {
                        msgElement.style.background = '#f8d7da';
                        msgElement.style.color = '#721c24';
                    }
                })
                .catch(err => {
                    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err);
                });
        }
    </script>
</body>

</html>