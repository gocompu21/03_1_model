{% load bbs_extras %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë¬´ì˜ì‚¬ í”„ë¡œí•„</title>
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Summernote/jQuery for Inline Editing -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/lang/summernote-ko-KR.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f7f4;
            display: flex;
            flex-direction: column;
            /* Changed to column for Header + Body */
            height: 100vh;
            overflow: hidden;
        }

        /* --- Header Styles (Copied from index.html) --- */
        header {
            background-color: #2d6a4f;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex: 0 0 auto;
            /* Header doesn't shrink/grow */
            z-index: 10;
        }

        .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #b7e4c7;
        }

        /* --- Layout Container for Sidebar + Content --- */
        .app-container {
            display: flex;
            flex: 1;
            /* Take remaining height */
            overflow: hidden;
            /* Prevent body scroll, handle inside vars */
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: 250px;
            background-color: #1b4332;
            /* Slightly darker to distinguish from header */
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 1.2rem;
            /* Adjusted size */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 20px;
            margin-top: 0;
        }

        .menu-item {
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 1rem;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover,
        .menu-item.active {
            background-color: #40916c;
            color: white;
            font-weight: bold;
        }

        .back-home {
            margin-top: auto;
            background-color: rgba(0, 0, 0, 0.2);
        }

        /* --- Main Content Styles --- */
        .main-content {
            flex: 1;
            padding: 7px 40px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            background: white;
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            max-width: 800px;
            margin: 0 auto;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #1b4332;
            margin-bottom: 30px;
            border-left: 5px solid #2d6a4f;
            padding-left: 15px;
        }

        /* Info Table Styles */
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .info-table th,
        .info-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .info-table th {
            width: 150px;
            color: #2d6a4f;
            font-weight: bold;
            background-color: #f8f9fa;
        }

        /* History Table Styles */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }

        .history-table th,
        .history-table td {
            padding: 8px 10px;
            /* Compact Padding */
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
            /* Slightly smaller text */
        }

        .history-table th {
            background-color: #f1f8f5;
            color: #2d6a4f;
            font-weight: bold;
        }

        .pass-badge {
            display: inline-block;
            padding: 3px 8px;
            /* Compact badge */
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 0.75rem;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            list-style: none;
            padding: 0;
            gap: 5px;
        }

        .pagination a {
            text-decoration: none;
            padding: 6px 12px;
            border: 1px solid #ddd;
            color: #333;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .pagination a.active {
            background-color: #2d6a4f;
            color: white;
            border-color: #2d6a4f;
        }

        .pagination a:hover:not(.active) {
            background-color: #eee;
        }

        .pass-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .pass {
            background-color: #40916c;
        }

        .fail {
            background-color: #e63946;
        }


        .btn {
            display: inline-block;
            padding: 10px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background 0.3s;
        }

        .btn-primary {
            background-color: #2d6a4f;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1b4332;
        }

        .btn-danger {
            background-color: #e63946;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c1121f;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .menu-item i {
            margin-right: 10px;
            width: 24px;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- Header (Copied from index.html) -->
    <header>
        <a href="{% url 'main:index' %}" class="logo">ğŸŒ³ ë‚˜ë¬´ì˜ì‚¬ í•©ê²©ë°˜</a>
        <nav class="nav-links">
            {% if user.is_authenticated %}
            <span>{{ user.username }}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤</span>
            <a href="{% url 'mypage:index' %}">ë§ˆì´í˜ì´ì§€</a>
            <form action="{% url 'accounts:user_logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit"
                    style="background:none; border:none; color:rgba(255,255,255,0.8); cursor:pointer; font-size:1rem; font-weight:500; margin-left:15px;">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
            {% else %}
            <a href="{% url 'accounts:user_login' %}">ë¡œê·¸ì¸</a>
            <a href="{% url 'accounts:user_signup' %}">íšŒì›ê°€ì…</a>
            {% endif %}
        </nav>
    </header>

    <!-- App Container (Sidebar + Content) -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="menu-item active" onclick="showSection('my_questions')">
                <i class="fas fa-question-circle"></i> ë‚´ ì§ˆë¬¸
            </div>
            <div class="menu-item" onclick="showSection('history')">
                <i class="fas fa-clipboard-list"></i> ëª¨ì˜ê³ ì‚¬ ê¸°ë¡
            </div>
            <div class="menu-item" onclick="showSection('analysis')">
                <i class="fas fa-chart-pie"></i> ê³¼ëª©ë³„ ì‹¤ë ¥ë¶„ì„
            </div>
            <div class="menu-item" onclick="showSection('info')">
                <i class="fas fa-user"></i> íšŒì› ì •ë³´
            </div>

            <a href="{% url 'main:index' %}" class="menu-item back-home">
                <i class="fas fa-home"></i> í™ˆìœ¼ë¡œ
            </a>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <div id="my-questions-section" class="content-section active">
                <div id="question-list-view">
                    {% include 'mypage/my_questions_partial.html' %}
                </div>
                <div id="question-detail-view" style="display: none;">
                    <!-- Detail content loaded via AJAX -->

                    <div id="detail-content-area"></div>
                    <div id="next-questions-list"
                        style="margin-top: 0px; border-top: 1px solid #eee; padding-top: 10px;">
                        <!-- Next 3 questions will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Section 1: Member Info -->
            <div id="info-section" class="content-section">
                <h1>íšŒì› ì •ë³´</h1>
                <table class="info-table">
                    <tr>
                        <th>ì•„ì´ë””</th>
                        <td>{{ user.username }}</td>
                    </tr>
                    <tr>
                        <th>ì´ë©”ì¼</th>
                        <td>{{ user.email|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>ì´ë¦„</th>
                        <td>{{ user.first_name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>ê°€ì…ì¼</th>
                        <td>{{ user.date_joined|date:"Y/m/d" }}</td>
                    </tr>
                    <tr>
                        <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                        <td>{{ user.last_login|date:"Y/m/d" }} ({{ days_since_login }}ì¼ ì „)</td>
                    </tr>
                </table>

                <div style="display: flex; justify-content: space-between;">
                    <a href="{% url 'mypage:edit' %}" class="btn btn-primary">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ ìˆ˜ì •</a>
                </div>
            </div>

            <!-- Section 2: Exam History (New) -->
            <div id="history-section" class="content-section">
                <h1>ë‚˜ì˜ ëª¨ì˜ê³ ì‚¬ ê¸°ë¡</h1>

                <div id="history-list-container">
                    {% include 'mypage/history_partial.html' %}
                </div>
            </div>

            <!-- Section 3: Analysis -->
            <div id="analysis-section" class="content-section">
                <h1>ê³¼ëª©ë³„ ì‹¤ë ¥ ë¶„ì„</h1>

                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>

                {% if weakest_subject and weakest_subject != "ì•„ì§ í•™ìŠµ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." %}
                <div
                    style="margin-top: 30px; padding: 20px; background-color: #fff5f5; border-left: 5px solid #ff6b6b; border-radius: 8px;">
                    <h3 style="margin: 0 0 10px 0; color: #c92a2a;">ğŸ”¥ ì§‘ì¤‘ ì¼€ì–´ í•„ìš”</h3>
                    <p style="margin: 0; color: #495057;">
                        í˜„ì¬ <strong>{{ weakest_subject }}</strong> ê³¼ëª©ì˜ ì •ë‹µë¥ ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.<br>
                        í•´ë‹¹ ê³¼ëª©ì˜ ê¸°ì¶œë¬¸ì œë¥¼ ì§‘ì¤‘ì ìœ¼ë¡œ í’€ì–´ë³´ì‹œëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                    </p>
                </div>
                {% elif weakest_subject %}
                <div style="margin-top: 50px; text-align: center; color: #868e96;">
                    <p>{{ weakest_subject }}</p>
                    <a href="{% url 'exam:index' %}" class="btn btn-primary" style="margin-top:10px;">ê¸°ì¶œë¬¸ì œ í’€ëŸ¬ê°€ê¸°</a>
                </div>
                {% endif %}
            </div>


        </div>

    </div>
    </div> <!-- Script for Tab Switching & Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Tab Switching Logic
        function showSection(sectionId) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));

            if (sectionId === 'my_questions') {
                document.querySelectorAll('.menu-item')[0].classList.add('active');
                document.getElementById('my-questions-section').classList.add('active');
                // Reset to list view if it was in detail
                showListView();
            } else if (sectionId === 'history') {
                document.querySelectorAll('.menu-item')[1].classList.add('active');
                document.getElementById('history-section').classList.add('active');
            } else if (sectionId === 'analysis') {
                document.querySelectorAll('.menu-item')[2].classList.add('active');
                document.getElementById('analysis-section').classList.add('active');
            } else if (sectionId === 'info') {
                document.querySelectorAll('.menu-item')[3].classList.add('active');
                document.getElementById('info-section').classList.add('active');
            }
        }

        function loadPostDetail(url) {
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const content = doc.querySelector('.bbs-container');

                    if (content) {
                        // Remove Comment Section (Box) entirely
                        const commentSection = content.querySelector('#comment-section');
                        if (commentSection) {
                            commentSection.remove();
                        } else {
                            const commentForms = content.querySelectorAll('form');
                            commentForms.forEach(form => form.remove());
                        }

                        document.getElementById('detail-content-area').innerHTML = '';
                        document.getElementById('detail-content-area').appendChild(content);

                        document.getElementById('question-list-view').style.display = 'none';
                        const detailView = document.getElementById('question-detail-view');
                        detailView.style.display = 'block';

                        detailView.scrollIntoView({ behavior: 'smooth', block: 'start' });

                        if (window.MathJax) {
                            MathJax.typesetPromise([content]).catch((err) => console.log(err));
                        }
                    }
                })
                .catch(err => console.error('Failed to load post:', err));
        }

        function showListView() {
            const detailView = document.getElementById('question-detail-view');
            const listView = document.getElementById('question-list-view');

            if (detailView && listView) {
                detailView.style.display = 'none';
                listView.style.display = 'block';

                // Clean up detail area
                const detailArea = document.getElementById('detail-content-area');
                if (detailArea) detailArea.innerHTML = '';
            }
        }

        // Initialize Chart & Tab Persistence
        document.addEventListener("DOMContentLoaded", function () {
            // Check URL param for tab
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab') || 'my_questions'; // Default to my_questions

            showSection(activeTab);

            const ctx = document.getElementById('radarChart').getContext('2d');
            const labels = JSON.parse('{{ radar_labels|safe }}');
            const data = JSON.parse('{{ radar_data|safe }}');

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì •ë‹µë¥  (%)',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(45, 106, 79, 0.2)',
                        borderColor: 'rgba(45, 106, 79, 1)',
                        pointBackgroundColor: 'rgba(45, 106, 79, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(45, 106, 79, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: { stepSize: 20, backdropColor: 'transparent' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // --- AJAX Pagination Logic ---
            const historyContainer = document.getElementById('history-list-container');

            historyContainer.addEventListener('click', function (e) {
                if (e.target.tagName === 'A' && e.target.classList.contains('ajax-link')) {
                    e.preventDefault();
                    const url = e.target.href;

                    fetch(url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.text())
                        .then(html => {
                            historyContainer.innerHTML = html;
                            // Optional: Scroll to top of table if needed, or stay put (requested by user)
                        })
                        .catch(error => console.error('Error:', error));
                }
            });

            // --- AJAX Post Detail Logic ---
            const myQuestionsSection = document.getElementById('my-questions-section');
            if (myQuestionsSection) {
                // Handle Pagination AJAX
                myQuestionsSection.addEventListener('click', function (e) {
                    if (e.target.tagName === 'A' && e.target.classList.contains('q-ajax-link')) {
                        e.preventDefault();
                        const url = e.target.href;
                        const listView = document.getElementById('question-list-view');

                        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                            .then(response => response.text())
                            .then(html => {
                                listView.innerHTML = html;
                                // Scroll slightly if needed, but staying put is usually requested
                            })
                            .catch(error => console.error('Error:', error));
                        return; // Done
                    }

                    const link = e.target.closest('.post-link');
                    if (link) {
                        e.preventDefault();
                        const url = link.href;

                        // --- Render Next Questions Logic Removed ---
                        loadPostDetail(url);
                    }
                });
            }

            // --- Inline Edit Logic ---
            const detailArea = document.getElementById('detail-content-area');
            if (detailArea) {
                detailArea.addEventListener('click', function (e) {
                    const editBtn = e.target.closest('.btn-edit');
                    if (editBtn) {
                        e.preventDefault();
                        const url = editBtn.href;

                        fetch(url)
                            .then(response => response.text())
                            .then(html => {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const content = doc.querySelector('.bbs-container');

                                if (content) {
                                    // Remove Header (User request)
                                    // Remove Header (User request)
                                    const header = content.querySelector('h2');
                                    if (header) header.remove();

                                    // Add Help Text (Re-adding as explanation)
                                    const helpDiv = document.createElement('div');
                                    helpDiv.style.cssText = 'color: #666; font-size: 0.85rem; margin-bottom: 10px; padding: 0 5px;';
                                    helpDiv.innerHTML = '<i class="fas fa-info-circle"></i> ìˆ˜ì‹ì€ í¸ì§‘ ëª¨ë“œì—ì„œ $...$ í˜•íƒœì˜ ì½”ë“œë¡œ í‘œì‹œë©ë‹ˆë‹¤.';
                                    const formEl = content.querySelector('form');
                                    if (formEl) content.insertBefore(helpDiv, formEl);

                                    detailArea.innerHTML = '';
                                    detailArea.appendChild(content);

                                    // Make 'Cancel' button work inline (reload original detail)
                                    const cancelBtn = content.querySelector('.btn-cancel');
                                    if (cancelBtn) {
                                        cancelBtn.onclick = function (ev) {
                                            ev.preventDefault();
                                            // Detail URL is the parent of update URL: /bbs/post/<pk>/
                                            const detailUrl = url.split('/').slice(0, -2).join('/') + '/';
                                            loadPostDetail(detailUrl);
                                        }
                                    }

                                    // Initialize Summernote (if available) - requires jQuery
                                    if (typeof $ !== 'undefined' && $.fn.summernote) {
                                        $('#summernote').summernote({
                                            placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                                            tabsize: 2,
                                            height: 400,
                                            lang: 'ko-KR',
                                            toolbar: [
                                                ['style', ['style']],
                                                ['font', ['bold', 'underline', 'clear']],
                                                ['color', ['color']],
                                                ['para', ['ul', 'ol', 'paragraph']],
                                                ['table', ['table']],
                                            ]
                                        });

                                        // Intercept Form Submission
                                        const form = detailArea.querySelector('form');
                                        if (form) {
                                            form.addEventListener('submit', function (ev) {
                                                ev.preventDefault();

                                                // Sync Summernote content to textarea
                                                if (typeof $ !== 'undefined' && $('#summernote').summernote) {
                                                    const summernoteContent = $('#summernote').summernote('code');
                                                    const contentArea = form.querySelector('#summernote');
                                                    if (contentArea) {
                                                        contentArea.value = summernoteContent;
                                                    }
                                                }

                                                const formData = new FormData(form);

                                                fetch(url, {
                                                    method: 'POST',
                                                    body: formData,
                                                    headers: {
                                                        'X-Requested-With': 'XMLHttpRequest'
                                                    }
                                                })
                                                    .then(response => {
                                                        if (response.redirected || response.url !== url) {
                                                            return fetch(response.url).then(res => res.text());
                                                        }
                                                        return response.text();
                                                    })
                                                    .then(newHtml => {
                                                        const newDoc = new DOMParser().parseFromString(newHtml, 'text/html');
                                                        const newContent = newDoc.querySelector('.bbs-container');

                                                        if (newContent) {
                                                            detailArea.innerHTML = '';
                                                            detailArea.appendChild(newContent);

                                                            if (!newContent.querySelector('form')) {
                                                                // Success: Re-apply List button and cleanup
                                                                const actionContainer = newContent.querySelector('#post-actions');
                                                                if (actionContainer) {
                                                                    const newListBtn = document.createElement('a');
                                                                    newListBtn.href = '#';
                                                                    newListBtn.className = 'btn-action btn-list';
                                                                    newListBtn.innerHTML = '<i class="fas fa-list"></i> ëª©ë¡';
                                                                    newListBtn.onclick = function (e) {
                                                                        e.preventDefault();
                                                                        showListView();
                                                                    };
                                                                    actionContainer.appendChild(newListBtn);
                                                                }
                                                                const commentSection = newContent.querySelector('#comment-section');
                                                                if (commentSection) commentSection.remove();

                                                                document.getElementById('question-detail-view').scrollIntoView({ behavior: 'smooth', block: 'start' });

                                                                if (window.MathJax) {
                                                                    setTimeout(() => {
                                                                        const freshDetail = document.getElementById('detail-content-area');
                                                                        MathJax.typesetPromise([freshDetail]);
                                                                    }, 100);
                                                                }
                                                            }
                                                        }
                                                    });
                                            });
                                        }
                                    }
                                }
                            });
                    }
                });
            }

            // showListView moved to global scope
        });
    </script>
</body>

</html>