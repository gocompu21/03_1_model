{% load bbs_extras %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë¬´ì˜ì‚¬ í”„ë¡œí•„</title>
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Summernote/jQuery for Inline Editing -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/lang/summernote-ko-KR.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f7f4;
            display: flex;
            flex-direction: column;
            /* Changed to column for Header + Body */
            height: 100vh;
            overflow: hidden;
        }

        /* --- Header Styles (Copied from index.html) --- */
        header {
            background-color: #2d6a4f;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex: 0 0 auto;
            /* Header doesn't shrink/grow */
            z-index: 10;
        }

        .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #b7e4c7;
        }

        /* --- Layout Container for Sidebar + Content --- */
        .app-container {
            display: flex;
            flex: 1;
            /* Take remaining height */
            overflow: hidden;
            /* Prevent body scroll, handle inside vars */
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: 250px;
            background-color: #1b4332;
            /* Slightly darker to distinguish from header */
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 1.2rem;
            /* Adjusted size */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 20px;
            margin-top: 0;
        }

        .menu-item {
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 1rem;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover,
        .menu-item.active {
            background-color: #40916c;
            color: white;
            font-weight: bold;
        }

        .back-home {
            margin-top: auto;
            background-color: rgba(0, 0, 0, 0.2);
        }

        /* --- Main Content Styles --- */
        .main-content {
            flex: 1;
            padding: 7px 40px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            background: white;
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            max-width: 800px;
            margin: 0 auto;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #1b4332;
            margin-bottom: 30px;
            border-left: 5px solid #2d6a4f;
            padding-left: 15px;
        }

        /* Info Table Styles */
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .info-table th,
        .info-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .info-table th {
            width: 150px;
            color: #2d6a4f;
            font-weight: bold;
            background-color: #f8f9fa;
        }

        /* History Table Styles */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }

        .history-table th,
        .history-table td {
            padding: 8px 10px;
            /* Compact Padding */
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
            /* Slightly smaller text */
        }

        .history-table th {
            background-color: #f1f8f5;
            color: #2d6a4f;
            font-weight: bold;
        }

        .pass-badge {
            display: inline-block;
            padding: 3px 8px;
            /* Compact badge */
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 0.75rem;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            list-style: none;
            padding: 0;
            margin-top: 20px;
            gap: 5px;
        }

        .pagination li {
            margin: 0;
        }

        .pagination li a {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 32px;
            height: 32px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            color: #495057;
            text-decoration: none;
            font-size: 0.9rem;
            background-color: #fff;
            transition: all 0.2s;
        }

        .pagination li a:hover {
            background-color: #e9ecef;
            border-color: #dee2e6;
            color: #212529;
        }

        .pagination li a.active {
            background-color: #2d6a4f;
            border-color: #2d6a4f;
            color: #fff;
            font-weight: bold;
        }

        .pagination a:hover:not(.active) {
            background-color: #eee;
        }

        .pass-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .pass {
            background-color: #40916c;
        }

        .fail {
            background-color: #e63946;
        }


        .btn {
            display: inline-block;
            padding: 10px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background 0.3s;
        }

        .btn-primary {
            background-color: #2d6a4f;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1b4332;
        }

        .btn-danger {
            background-color: #e63946;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c1121f;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .menu-item i {
            margin-right: 10px;
            width: 24px;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- Header (Copied from index.html) -->
    <header>
        <a href="{% url 'main:index' %}" class="logo">ğŸŒ³ ë‚˜ë¬´ì˜ì‚¬ í•©ê²©ë°˜</a>
        <nav class="nav-links">
            {% if user.is_authenticated %}
            <span>{{ user.username }}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤</span>
            <a href="{% url 'mypage:index' %}">ë§ˆì´í˜ì´ì§€</a>
            <form action="{% url 'accounts:user_logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit"
                    style="background:none; border:none; color:rgba(255,255,255,0.8); cursor:pointer; font-size:1rem; font-weight:500; margin-left:15px;">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
            {% else %}
            <a href="{% url 'accounts:user_login' %}">ë¡œê·¸ì¸</a>
            <a href="{% url 'accounts:user_signup' %}">íšŒì›ê°€ì…</a>
            {% endif %}
        </nav>
    </header>

    <!-- App Container (Sidebar + Content) -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="menu-item{% if review_count > 0 %} active{% endif %}" onclick="showSection('review')">
                <i class="fas fa-brain"></i> ì˜¤ëŠ˜ì˜ ë³µìŠµ
                {% if review_count > 0 %}
                <span
                    style="background-color: #e63946; color: white; border-radius: 50%; padding: 2px 8px; font-size: 0.75rem; margin-left: 5px;">
                    {{ review_count }}</span>
                {% endif %}
            </div>
            <div class="menu-item{% if review_count == 0 %} active{% endif %}" onclick="showSection('wrong_answer')">
                <i class="fas fa-times-circle"></i> ì „ì²´ ì˜¤ë‹µ ë…¸íŠ¸
            </div>
            <div class="menu-item" onclick="showSection('my_questions')">
                <i class="fas fa-question-circle"></i> ë‚˜ì˜ ì§ˆì˜ì‘ë‹µ
            </div>
            <div class="menu-item" onclick="showSection('history')">
                <i class="fas fa-clipboard-list"></i> ê¸°ì¶œì‹œí—˜ ê²°ê³¼
            </div>
            <div class="menu-item" onclick="showSection('analysis')">
                <i class="fas fa-chart-pie"></i> ê³¼ëª©ë³„ ì‹¤ë ¥ë¶„ì„
            </div>

            <div class="menu-item" onclick="showSection('ai_analysis')">
                <i class="fas fa-robot"></i> ë‚´ ìµœê·¼ ì§ˆì˜ ë¶„ì„
            </div>
            <div class="menu-item" onclick="showSection('info')">
                <i class="fas fa-user"></i> íšŒì› ì •ë³´
            </div>

            {% if user.is_superuser %}
            <a href="{% url 'mypage:prompt_generator' %}" class="menu-item" style="color: #ff9800;">
                <i class="fas fa-cog"></i> ë¬¸ì œ ê´€ë¦¬
            </a>
            {% endif %}

            <a href="{% url 'main:index' %}" class="menu-item back-home">
                <i class="fas fa-home"></i> í™ˆìœ¼ë¡œ
            </a>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- Section: Smart Review Recommendations -->
            <div id="review-section" class="content-section{% if review_count > 0 %} active{% endif %}">
                <h1><i class="fas fa-brain" style="color: #2d6a4f;"></i> ì˜¤ëŠ˜ì˜ ë³µìŠµ ì¶”ì²œ</h1>
                {% if review_recommendations %}
                <p style="color: #666; margin-bottom: 20px;">
                    ì—ë¹™í•˜ìš°ìŠ¤ ë§ê°ê³¡ì„ ì— ê¸°ë°˜í•˜ì—¬ ì˜¤ëŠ˜ ë³µìŠµí•´ì•¼ í•  ë¬¸ì œë“¤ì…ë‹ˆë‹¤.<br>
                    <strong>ì´ {{ review_count }}ê°œ</strong>ì˜ ë¬¸ì œê°€ ë³µìŠµì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.
                </p>
                <div style="display: grid; gap: 15px;">
                    {% for schedule in review_recommendations %}
                    <div
                        style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #2d6a4f;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">
                                    {{ schedule.question.subject.name }} Â· ì œ{{ schedule.question.exam.round_number }}íšŒ
                                    {{ schedule.question.number }}ë²ˆ
                                </div>
                                <div style="font-weight: 500; line-height: 1.5;">
                                    {{ schedule.question.content|truncatechars:80 }}
                                </div>
                                <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                                    <i class="fas fa-calendar-alt"></i> ë§ˆì§€ë§‰ ì˜¤ë‹µ:
                                    {{schedule.last_wrong_date|date:"Y.m.d"}}
                                    <span style="margin-left: 10px;"><i class="fas fa-redo"></i> ë³µìŠµ
                                        {{schedule.review_count }}íšŒì°¨</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <a href="{% url 'mypage:review_start' %}"
                        style="display: inline-block; padding: 15px 40px; background-color: #2d6a4f; color: white; text-decoration: none; border-radius: 30px; font-weight: bold; font-size: 1.1rem; transition: background-color 0.3s;">
                        <i class="fas fa-play-circle"></i> ë³µìŠµ ì‹œì‘í•˜ê¸°
                    </a>
                </div>
                {% else %}
                <div
                    style="text-align: center; padding: 60px 20px; color: #888; background: #f8f9fa; border-radius: 12px;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: #2d6a4f; margin-bottom: 20px;"></i>
                    <p style="font-size: 1.1rem;">ì˜¤ëŠ˜ ë³µìŠµí•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì˜í•˜ê³  ìˆì–´ìš”! ğŸ‰</p>
                </div>
                {% endif %}
            </div>


            <div id="my-questions-section" class="content-section">
                <div id="question-list-view">
                    <h1>ë‚˜ì˜ ì§ˆì˜ì‘ë‹µ</h1>
                    {% include 'mypage/my_questions_partial.html' %}
                </div>
                <div id="question-detail-view" style="display: none;">
                    <!-- Detail content loaded via AJAX -->

                    <div id="detail-content-area"></div>
                    <div id="next-questions-list"
                        style="margin-top: 0px; border-top: 1px solid #eee; padding-top: 10px;">
                        <!-- Next 3 questions will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Section 1: Member Info -->
            <div id="info-section" class="content-section">
                <h1>íšŒì› ì •ë³´</h1>
                <table class="info-table">
                    <tr>
                        <th>ì•„ì´ë””</th>
                        <td>{{ user.username }}</td>
                    </tr>
                    <tr>
                        <th>ì´ë©”ì¼</th>
                        <td>{{ user.email|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>ì´ë¦„</th>
                        <td>{{ user.first_name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>ê°€ì…ì¼</th>
                        <td>{{ user.date_joined|date:"Y/m/d" }}</td>
                    </tr>
                    <tr>
                        <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                        <td>{{ user.last_login|date:"Y/m/d" }} ({{ days_since_login }}ì¼ ì „)</td>
                    </tr>
                </table>

                <div style="display: flex; justify-content: space-between;">
                    <a href="{% url 'mypage:edit' %}" class="btn btn-primary">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ ìˆ˜ì •</a>
                </div>
            </div>

            <!-- Section 2: Exam History (New) -->
            <div id="history-section" class="content-section">
                <h1>ê¸°ì¶œì‹œí—˜ ê²°ê³¼</h1>

                <div id="history-list-container">
                    {% include 'mypage/history_partial.html' %}
                </div>

                <!-- Loading Indicator (Hidden by default) -->
                <div id="history-loading-indicator" style="display: none; text-align: center; padding: 50px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #2d6a4f;"></i>
                    <p style="margin-top: 15px; color: #666; font-size: 1.1rem;">
                        <span style="font-weight: bold; color: #2d6a4f;">AI ë‚˜ë¬´ì£¼ì¹˜ì˜</span>ê°€ ì˜¤ë‹µì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...<br>
                        <span style="font-size: 0.9rem; color: #999;">(ìµœì´ˆ ë¶„ì„ ì‹œ 3~5ì´ˆ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)</span>
                    </p>
                </div>

                <!-- History Detail View (Hidden by default) -->
                <div id="history-detail-container" style="display: none;">
                    <div id="history-detail-content"></div>

                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="closeHistoryDetail()" class="btn-secondary"
                            style="padding: 10px 20px; font-size: 1rem; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px;">
                            <i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                </div>

                <!-- History Question Detail View (Level 3 - Hidden by default) -->
                <div id="history-question-detail-container" style="display: none;">
                    <button class="btn btn-sm btn-secondary" onclick="showHistoryDetailFromQuestion()"
                        style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; cursor: pointer; margin-bottom: 10px;">
                        <i class="fas fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
                    </button>
                    <div id="history-question-detail-content"></div>
                </div>
            </div>



            <!-- Section 3: Analysis -->
            <div id="analysis-section" class="content-section">
                <h1>ê³¼ëª©ë³„ ì‹¤ë ¥ ë¶„ì„</h1>

                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>

                <div id="weak-subject-info">
                    {% if weakest_subject and weakest_subject != "ì•„ì§ í•™ìŠµ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." %}
                    <div
                        style="margin-top: 30px; padding: 20px; background-color: #fff5f5; border-left: 5px solid #ff6b6b; border-radius: 8px;">
                        <h3 style="margin: 0 0 10px 0; color: #c92a2a;">ğŸ”¥ ì§‘ì¤‘ ì¼€ì–´ í•„ìš”</h3>
                        <p style="margin: 0; color: #495057;">
                            í˜„ì¬ <strong>{{ weakest_subject }}</strong> ê³¼ëª©ì˜ ì •ë‹µë¥ ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.<br>
                            í•´ë‹¹ ê³¼ëª©ì˜ ê¸°ì¶œë¬¸ì œë¥¼ ì§‘ì¤‘ì ìœ¼ë¡œ í’€ì–´ë³´ì‹œëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                    {% elif weakest_subject %}
                    <div style="margin-top: 50px; text-align: center; color: #868e96;">
                        <p>{{ weakest_subject }}</p>
                        <a href="{% url 'exam:index' %}" class="btn btn-primary" style="margin-top:10px;">ê¸°ì¶œë¬¸ì œ í’€ëŸ¬ê°€ê¸°</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Section 3.5: Wrong Answer Note (New) -->
            <div id="wrong-answer-section" class="content-section active">
                <!-- Detail View -->
                <div id="wrong-answer-detail-view" style="display: none;">
                    <div id="wrong-answer-detail-content"></div>
                </div>

                <!-- List View -->
                <div id="wrong-answer-list-view">
                    <h1>ì „ì²´ ì˜¤ë‹µ ë…¸íŠ¸</h1>
                    <p style="color: #666; margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i> í´ë¦­í•˜ë©´ í•´ë‹¹ ë¬¸ì œì˜ ìƒì„¸ í•´ì„¤ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    <div id="wrong-answer-list-container">
                        {% include 'mypage/wrong_answer_partial.html' %}
                    </div>
                </div>
            </div>

            <!-- Section 4: AI Analysis -->
            <div id="ai-analysis-section" class="content-section">
                <h1>ë‚´ ìµœê·¼ ì§ˆì˜ ë¶„ì„</h1>

                <div
                    style="margin-top: 20px; padding: 25px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; font-size: 1.25rem; color: #2d6a4f;">
                            <i class="fas fa-user-md"></i> ë‚˜ë¬´ì£¼ì¹˜ì˜ í•™ìŠµ ì§„ë‹¨
                        </h2>
                        <button id="btn-analyze" class="btn btn-primary"
                            style="padding: 10px 20px; font-size: 0.95rem;">
                            <i class="fas fa-magic"></i> AI ì§„ë‹¨ ìš”ì²­
                        </button>
                    </div>

                    <p style="color: #666; font-size: 0.95rem; margin-bottom: 25px; line-height: 1.6;">
                        <i class="fas fa-info-circle" style="color: #2d6a4f; margin-right: 5px;"></i>
                        <strong>ë‚˜ë¬´ì£¼ì¹˜ì˜ AI ì§„ë‹¨ì´ë€?</strong><br>
                        íšŒì›ë‹˜ì´ ìµœê·¼ì— ì‘ì„±í•˜ì‹  ì§ˆë¬¸ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ <span style="color: #2d6a4f; font-weight: bold;">í•™ìŠµ ìƒíƒœ, ì·¨ì•½í•œ ê³¼ëª©, ê´€ì‹¬
                            ë¶„ì•¼</span>ë¥¼
                        AIê°€ ì‹¬ì¸µ ë¶„ì„í•´ ë“œë¦½ë‹ˆë‹¤.<br>
                        ê°œì¸ ë§ì¶¤í˜• í•™ìŠµ ì¡°ì–¸ê³¼ ê²©ë ¤ ë©”ì‹œì§€ë¥¼ í†µí•´ í•©ê²©ìœ¼ë¡œ ê°€ëŠ” ê¸¸ì„ í™•ì¸í•´ ë³´ì„¸ìš”!
                    </p>

                    <div id="analysis-loading" style="display: none; text-align: center; padding: 30px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #adb5bd;"></i>
                        <p style="margin-top: 15px; color: #868e96;">ë‚˜ë¬´ì£¼ì¹˜ì˜ê°€ ì§ˆë¬¸ ë‚´ì—­ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    </div>

                    <div id="analysis-result" style="display: none; line-height: 1.7; color: #343a40;">
                        <!-- Analysis result will be injected here -->
                    </div>
                </div>
            </div>

        </div>

    </div>
    </div> <!-- Script for Tab Switching & Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Tab Switching Logic
        function showSection(sectionId) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));

            if (sectionId === 'review') {
                document.querySelectorAll('.menu-item')[0].classList.add('active');
                document.getElementById('review-section').classList.add('active');
            } else if (sectionId === 'wrong_answer') {
                document.querySelectorAll('.menu-item')[1].classList.add('active');
                document.getElementById('wrong-answer-section').classList.add('active');
                showWrongAnswerList();
            } else if (sectionId === 'my_questions') {
                document.querySelectorAll('.menu-item')[2].classList.add('active');
                document.getElementById('my-questions-section').classList.add('active');
                // Reset to list view if it was in detail
                showListView();
            } else if (sectionId === 'history') {
                document.querySelectorAll('.menu-item')[3].classList.add('active');
                document.getElementById('history-section').classList.add('active');

                // Reset to List View
                const list = document.getElementById('history-list-container');
                const detail = document.getElementById('history-detail-container');
                const qDetail = document.getElementById('history-question-detail-container');

                if (list) list.style.display = 'block';
                if (detail) detail.style.display = 'none';
                if (qDetail) qDetail.style.display = 'none';

                // Always reload history list
                fetch('{% url "mypage:index" %}', {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.text())
                    .then(html => {
                        if (list) list.innerHTML = html;
                    })
                    .catch(err => console.error('Failed to reload history:', err));
            } else if (sectionId === 'analysis') {
                document.querySelectorAll('.menu-item')[4].classList.add('active');
                document.getElementById('analysis-section').classList.add('active');
                updateChartData();
            } else if (sectionId === 'ai_analysis') {
                document.querySelectorAll('.menu-item')[5].classList.add('active');
                document.getElementById('ai-analysis-section').classList.add('active');
                resetAIAnalysis();
            } else if (sectionId === 'edit_profile' || sectionId === 'info') {
                document.querySelectorAll('.menu-item')[6].classList.add('active');
                document.getElementById('info-section').classList.add('active');
            }
        }

        function updateChartData() {
            fetch('{% url "mypage:index" %}?mode=analysis_data', {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(response => response.json())
                .then(data => {
                    // Update Chart
                    if (window.myRadarChart) {
                        window.myRadarChart.data.labels = data.labels;
                        window.myRadarChart.data.datasets[0].data = data.data;
                        window.myRadarChart.update();
                    }

                    // Update Weakest Subject Text
                    const container = document.getElementById('weak-subject-info');
                    if (container && data.weakest_subject) {
                        let html = '';
                        if (data.weakest_subject !== "ì•„ì§ í•™ìŠµ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.") {
                            html = `
                        <div style="margin-top: 30px; padding: 20px; background-color: #fff5f5; border-left: 5px solid #ff6b6b; border-radius: 8px;">
                            <h3 style="margin: 0 0 10px 0; color: #c92a2a;">ğŸ”¥ ì§‘ì¤‘ ì¼€ì–´ í•„ìš”</h3>
                            <p style="margin: 0; color: #495057;">
                                í˜„ì¬ <strong>${data.weakest_subject}</strong> ê³¼ëª©ì˜ ì •ë‹µë¥ ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.<br>
                                í•´ë‹¹ ê³¼ëª©ì˜ ê¸°ì¶œë¬¸ì œë¥¼ ì§‘ì¤‘ì ìœ¼ë¡œ í’€ì–´ë³´ì‹œëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                            </p>
                        </div>`;
                        } else {
                            html = `
                        <div style="margin-top: 50px; text-align: center; color: #868e96;">
                            <p>${data.weakest_subject}</p>
                            <a href="{% url 'exam:index' %}" class="btn btn-primary" style="margin-top:10px;">ê¸°ì¶œë¬¸ì œ í’€ëŸ¬ê°€ê¸°</a>
                        </div>`;
                        }
                        container.innerHTML = html;
                    }
                })
                .catch(err => console.error('Error updating chart:', err));
        }

        // ... existing functions ...



        // Show Wrong Answer List (Normal Tab)
        function showWrongAnswerList(params = '') {
            const detailView = document.getElementById('wrong-answer-detail-view');
            const listView = document.getElementById('wrong-answer-list-view');

            if (listView && detailView) {
                detailView.style.display = 'none';
                listView.style.display = 'block';

                if (params) {
                    const url = `{% url 'mypage:index' %}?w_page=1` + params;
                    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(response => response.text())
                        .then(html => {
                            document.getElementById('wrong-answer-list-container').innerHTML = html;
                        });
                }
            }
        }

        // Show History Detail (In-Place)
        function showHistoryDetail(attemptId) {
            const listContainer = document.getElementById('history-list-container');
            const detailContainer = document.getElementById('history-detail-container');
            const detailContent = document.getElementById('history-detail-content');

            if (listContainer && detailContainer) {
                const loadingIndicator = document.getElementById('history-loading-indicator');

                // Show Loading, Hide List
                listContainer.style.display = 'none';
                if (loadingIndicator) loadingIndicator.style.display = 'block';

                // Fetch filtered wrong answers with FULL DETAILS
                const url = `{% url 'mypage:index' %}?mode=full_details&attempt_id=${attemptId}`;
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(response => response.text())
                    .then(html => {
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        detailContent.innerHTML = html;
                        // Hide list, show detail
                        // listContainer.style.display = 'none'; // Already hidden
                        detailContainer.style.display = 'block';

                        // Scroll to top of section
                        document.getElementById('history-section').scrollIntoView({ behavior: 'smooth' });

                        // Trigger MathJax for the new content
                        if (window.MathJax) {
                            MathJax.typesetPromise([detailContent]).catch((err) => console.log('MathJax Error:', err));
                        }
                    })
                    .catch(err => {
                        console.error("Error loading history detail:", err);
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        listContainer.style.display = 'block'; // Revert to list on error
                        alert("ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    });
            }
        }

        function closeHistoryDetail() {
            const listContainer = document.getElementById('history-list-container');
            const detailContainer = document.getElementById('history-detail-container');

            if (listContainer && detailContainer) {
                detailContainer.style.display = 'none';
                listContainer.style.display = 'block';
                document.getElementById('history-detail-content').innerHTML = ''; // Clear content
            }
        }

        function loadWrongAnswersByAttempt(attemptId) {
            // Deprecated: Switching tabs. Now using showHistoryDetail
            showHistoryDetail(attemptId);
        }

        // History Detail Pagination Listener
        document.addEventListener('DOMContentLoaded', function () {
            const historyDetailContent = document.getElementById('history-detail-content');
            if (historyDetailContent) {
                historyDetailContent.addEventListener('click', function (e) {
                    if (e.target.tagName === 'A' && e.target.classList.contains('page-link') && e.target.dataset.type === 'wrong') {
                        e.preventDefault();
                        const page = e.target.dataset.page;
                        const attemptId = e.target.dataset.attemptId;

                        let params = `&w_page=${page}`;
                        if (attemptId) {
                            params += `&attempt_id=${attemptId}`;
                        }

                        const url = `{% url 'mypage:index' %}?` + params.substring(1);

                        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                            .then(response => response.text())
                            .then(html => {
                                historyDetailContent.innerHTML = html;
                                document.getElementById('history-section').scrollIntoView({ behavior: 'smooth' });
                            });
                    }
                });
            }
        });

        // Wrong Answer Pagination Listener
        document.addEventListener('DOMContentLoaded', function () {
            const waListContainer = document.getElementById('wrong-answer-list-view');
            if (waListContainer) {
                waListContainer.addEventListener('click', function (e) {
                    if (e.target.tagName === 'A' && e.target.classList.contains('page-link') && e.target.dataset.type === 'wrong') {
                        e.preventDefault();
                        const page = e.target.dataset.page;
                        const attemptId = e.target.dataset.attemptId;

                        let params = `&w_page=${page}`;
                        if (attemptId) {
                            params += `&attempt_id=${attemptId}`;
                        }

                        const url = `{% url 'mypage:index' %}?` + params.substring(1); // remove first &

                        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                            .then(response => response.text())
                            .then(html => {
                                document.getElementById('wrong-answer-list-container').innerHTML = html;
                            });
                    }
                });
            }
        });

        function loadWrongAnswerDetail(id) {
            // Context Aware Loading
            const historySection = document.getElementById('history-section');
            if (historySection && historySection.classList.contains('active')) {
                // Load into History Question Detail (L3)
                const listContainer = document.getElementById('history-detail-container');
                const qDetailContainer = document.getElementById('history-question-detail-container');
                const qDetailContent = document.getElementById('history-question-detail-content');

                if (qDetailContainer && listContainer) {
                    const url = `/mypage/wrong_answer/${id}/`;
                    fetch(url)
                        .then(response => response.text())
                        .then(html => {
                            qDetailContent.innerHTML = html;
                            listContainer.style.display = 'none';
                            qDetailContainer.style.display = 'block';
                            setTimeout(() => {
                                qDetailContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                if (window.MathJax) {
                                    MathJax.typesetPromise([qDetailContent]).catch((err) => console.log(err));
                                }
                            }, 100);
                        });
                }
                return;
            }

            // Normal Wrong Answer Tab Logic
            const listArea = document.getElementById('wrong-answer-list-view');
            const detailArea = document.getElementById('wrong-answer-detail-view');
            const detailContent = document.getElementById('wrong-answer-detail-content');

            if (listArea && detailArea) {
                const url = `/mypage/wrong_answer/${id}/`;
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        if (detailContent) detailContent.innerHTML = html;
                        listArea.style.display = 'none';
                        detailArea.style.display = 'block';

                        setTimeout(() => {
                            detailArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            if (window.MathJax) {
                                MathJax.typesetPromise([detailContent]).catch((err) => console.log(err));
                            }
                        }, 100);
                    });
            }
        }

        function resetAIAnalysis() {
            const result = document.getElementById('analysis-result');
            const loading = document.getElementById('analysis-loading');
            const btn = document.getElementById('btn-analyze');

            if (result) {
                result.style.display = 'none';
                result.innerHTML = ''; // Clear content to ensure fresh state
            }
            if (loading) loading.style.display = 'none';
            if (btn) btn.disabled = false;
        }

        // Initialize Chart & Tab Persistence
        document.addEventListener("DOMContentLoaded", function () {
            // Check URL param for tab
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab') || 'wrong_answer'; // Default to wrong_answer

            showSection(activeTab);

            const ctx = document.getElementById('radarChart').getContext('2d');
            const labels = JSON.parse('{{ radar_labels|safe }}');
            const data = JSON.parse('{{ radar_data|safe }}');

            window.myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì •ë‹µë¥  (%)',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(45, 106, 79, 0.2)',
                        borderColor: 'rgba(45, 106, 79, 1)',
                        pointBackgroundColor: 'rgba(45, 106, 79, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(45, 106, 79, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: { stepSize: 20, backdropColor: 'transparent' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // --- AJAX Pagination Logic ---
            const historyContainer = document.getElementById('history-list-container');

            historyContainer.addEventListener('click', function (e) {
                if (e.target.tagName === 'A' && e.target.classList.contains('ajax-link')) {
                    e.preventDefault();
                    const url = e.target.href;

                    fetch(url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.text())
                        .then(html => {
                            historyContainer.innerHTML = html;
                            // Optional: Scroll to top of table if needed, or stay put (requested by user)
                        })
                        .catch(error => console.error('Error:', error));
                }
            });

            // --- AJAX Post Detail Logic ---
            const myQuestionsSection = document.getElementById('my-questions-section');
            if (myQuestionsSection) {
                // Handle Pagination AJAX
                myQuestionsSection.addEventListener('click', function (e) {
                    if (e.target.tagName === 'A' && e.target.classList.contains('q-ajax-link')) {
                        e.preventDefault();
                        const url = e.target.href;
                        const listView = document.getElementById('question-list-view');

                        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                            .then(response => response.text())
                            .then(html => {
                                listView.innerHTML = html;
                                // Scroll slightly if needed, but staying put is usually requested
                            })
                            .catch(error => console.error('Error:', error));
                        return; // Done
                    }

                    const link = e.target.closest('.post-link');
                    if (link) {
                        e.preventDefault();
                        const url = link.href;

                        // --- Render Next Questions Logic Removed ---
                        loadPostDetail(url);
                    }
                });
            }

            // --- Inline Edit Logic ---
            const detailArea = document.getElementById('detail-content-area');
            if (detailArea) {
                detailArea.addEventListener('click', function (e) {
                    const editBtn = e.target.closest('.btn-edit');
                    if (editBtn) {
                        e.preventDefault();
                        const url = editBtn.href;

                        fetch(url)
                            .then(response => response.text())
                            .then(html => {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const content = doc.querySelector('.bbs-container');

                                if (content) {
                                    // Remove Header (User request)
                                    // Remove Header (User request)
                                    const header = content.querySelector('h2');
                                    if (header) header.remove();

                                    // Add Help Text (Re-adding as explanation)
                                    const helpDiv = document.createElement('div');
                                    helpDiv.style.cssText = 'color: #666; font-size: 0.85rem; margin-bottom: 10px; padding: 0 5px;';
                                    helpDiv.innerHTML = '<i class="fas fa-info-circle"></i> ìˆ˜ì‹ì€ í¸ì§‘ ëª¨ë“œì—ì„œ $...$ í˜•íƒœì˜ ì½”ë“œë¡œ í‘œì‹œë©ë‹ˆë‹¤.';
                                    const formEl = content.querySelector('form');
                                    if (formEl) content.insertBefore(helpDiv, formEl);

                                    detailArea.innerHTML = '';
                                    detailArea.appendChild(content);

                                    // Make 'Cancel' button work inline (reload original detail)
                                    const cancelBtn = content.querySelector('.btn-cancel');
                                    if (cancelBtn) {
                                        cancelBtn.onclick = function (ev) {
                                            ev.preventDefault();
                                            // Fix logic for different URL structures
                                            let detailUrl = url.replace('update_my_question', 'detail_answer').replace('bbs/post', 'detail_answer');
                                            // Handle potential mismatch if still using bbs update
                                            if (url.includes('bbs/post/update')) {
                                                detailUrl = url.replace('update/', '');
                                            }

                                            if (typeof loadMyQuestionDetail === 'function') {
                                                loadMyQuestionDetail(detailUrl);
                                            } else {
                                                loadPostDetail(detailUrl);
                                            }
                                        }
                                    }

                                    // Initialize Summernote (if available) - requires jQuery
                                    if (typeof $ !== 'undefined' && $.fn.summernote) {
                                        $('#summernote').summernote({
                                            placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                                            tabsize: 2,
                                            height: 400,
                                            lang: 'ko-KR',
                                            toolbar: [
                                                ['style', ['style']],
                                                ['font', ['bold', 'underline', 'clear']],
                                                ['color', ['color']],
                                                ['para', ['ul', 'ol', 'paragraph']],
                                                ['table', ['table']],
                                            ]
                                        });

                                        // Intercept Form Submission
                                        const form = detailArea.querySelector('form');
                                        if (form) {
                                            form.addEventListener('submit', function (ev) {
                                                ev.preventDefault();

                                                // Sync Summernote content to textarea
                                                if (typeof $ !== 'undefined' && $('#summernote').summernote) {
                                                    const summernoteContent = $('#summernote').summernote('code');
                                                    const contentArea = form.querySelector('#summernote');
                                                    if (contentArea) {
                                                        contentArea.value = summernoteContent;
                                                    }
                                                }

                                                const formData = new FormData(form);

                                                fetch(url, {
                                                    method: 'POST',
                                                    body: formData,
                                                    headers: {
                                                        'X-Requested-With': 'XMLHttpRequest'
                                                    }
                                                })
                                                    .then(response => {
                                                        if (response.redirected || response.url !== url) {
                                                            // Check if redirected to index (list view)
                                                            if (response.url.includes('mypage') && !response.url.includes('detail') && !response.url.includes('update')) {
                                                                window.location.href = response.url;
                                                                return null; // Stop processing
                                                            }
                                                            return fetch(response.url).then(res => res.text());
                                                        }
                                                        return response.text();
                                                    })
                                                    .then(newHtml => {
                                                        if (!newHtml) return; // Stoped due to redirect

                                                        const newDoc = new DOMParser().parseFromString(newHtml, 'text/html');
                                                        const newContent = newDoc.querySelector('.bbs-container');

                                                        if (newContent) {
                                                            detailArea.innerHTML = '';
                                                            detailArea.appendChild(newContent);

                                                            if (!newContent.querySelector('form')) {
                                                                // Success: Re-apply List button and cleanup
                                                                const actionContainer = newContent.querySelector('#post-actions');
                                                                if (actionContainer) {
                                                                    // List button logic omitted as per previous code, but ensure scroll
                                                                }
                                                                const commentSection = newContent.querySelector('#comment-section');
                                                                // Removing comment section is debatable, user might want to see it, but keeping existing behavior
                                                                if (commentSection) commentSection.remove();

                                                                document.getElementById('question-detail-view').scrollIntoView({ behavior: 'smooth', block: 'start' });

                                                                // Force typeset on the new content with delay
                                                                setTimeout(() => {
                                                                    if (window.MathJax && window.MathJax.typesetPromise) {
                                                                        MathJax.typesetPromise()
                                                                            .then(() => console.log('MathJax global typeset complete'))
                                                                            .catch((err) => console.error('MathJax global typeset failed:', err));
                                                                    }
                                                                }, 100);
                                                            }
                                                        }
                                                    });
                                            });
                                        }
                                    }
                                }
                            });
                    }
                });
            }

            // showListView moved to global scope

            // --- Tree Doctor Analysis Logic ---
            const analyzeBtn = document.getElementById('btn-analyze');
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', function () {
                    const loading = document.getElementById('analysis-loading');
                    const result = document.getElementById('analysis-result');

                    analyzeBtn.disabled = true;
                    loading.style.display = 'block';
                    result.style.display = 'none';

                    fetch("{% url 'mypage:analyze_questions' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            loading.style.display = 'none';
                            analyzeBtn.disabled = false;

                            if (data.status === 'success') {
                                result.innerHTML = data.analysis;
                                result.style.display = 'block';

                                // Trigger MathJax for the new content
                                if (window.MathJax) {
                                    MathJax.typesetPromise([result]).catch((err) => console.log('MathJax Error:', err));
                                }
                            } else {
                                alert(data.message || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            loading.style.display = 'none';
                            analyzeBtn.disabled = false;
                            alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                });
            }
        });

        // Global Pagination Handler (Moved from nested scope)
        document.body.addEventListener('click', function (e) {
            if (e.target.classList.contains('page-link')) {
                e.preventDefault();

                const page = e.target.getAttribute('data-page');
                const type = e.target.getAttribute('data-type');

                let url = `?page=${page}`; // default for history
                let containerId = 'history-list-container';

                if (type === 'wrong') {
                    url = `?w_page=${page}`;
                    containerId = 'wrong-answer-list-container';
                }

                // Check if it's the question list pagination
                if (e.target.closest('#question-list-view')) {
                    url = `?q_page=${page}`;
                    containerId = 'question-list-view';
                }

                fetch(url, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.text())
                    .then(html => {
                        const container = document.getElementById(containerId);
                        if (container) {
                            container.innerHTML = html;
                        }
                    })
                    .catch(err => console.error('Pagination Error:', err));
            }
        });

        function switchExpTab(btn, type) {
            const section = btn.closest('.explanation-section');
            if (!section) return;

            // Reset Buttons
            section.querySelectorAll('.exp-tab-btn').forEach(b => {
                b.classList.remove('active');
                b.style.color = '#888';
                b.style.borderBottom = 'none';
            });

            // Activate Clicked Button
            btn.classList.add('active');
            btn.style.color = '#d35400';
            btn.style.borderBottom = '2px solid #d35400';

            // Toggle Content
            const tContent = section.querySelector('.textbook-content');
            const gContent = section.querySelector('.general-content');

            if (type === 'textbook') {
                if (tContent) tContent.style.display = 'block';
                if (gContent) gContent.style.display = 'none';
            } else {
                if (tContent) tContent.style.display = 'none';
                if (gContent) gContent.style.display = 'block';
            }
        }

        // My Questions Detail Handler
        document.addEventListener('click', function (e) {
            const link = e.target.closest('.post-link');
            // Ensure we are in the My Questions section to avoid conflict
            if (link && document.getElementById('my-questions-section') && document.getElementById('my-questions-section').contains(link)) {
                e.preventDefault();
                const url = link.getAttribute('href');
                loadMyQuestionDetail(url);
            }
        });

        function loadMyQuestionDetail(url) {
            const listSection = document.getElementById('question-list-view');
            const detailSection = document.getElementById('question-detail-view');
            const detailContent = document.getElementById('detail-content-area');

            if (listSection && detailSection) {
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        // Use DOMParser to ensure scripts/styles are handled cleaner if possible
                        // But mainly to be consistent with the edit-return logic
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        // detail_answer.html content is usually inside base.html's block content
                        // We try to find .bbs-container first
                        let newContent = doc.querySelector('.bbs-container');

                        // Fallback if full page structure is different
                        if (!newContent) {
                            newContent = doc.body;
                        }

                        detailContent.innerHTML = '';
                        detailContent.appendChild(newContent);

                        listSection.style.display = 'none';
                        detailSection.style.display = 'block';

                        // Scroll to top of detail view
                        detailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                        // Trigger styles/MathJax with a delay
                        setTimeout(() => {
                            if (window.MathJax && window.MathJax.typesetPromise) {
                                MathJax.typesetPromise() // Global scan
                                    .then(() => console.log('MathJax global typeset complete'))
                                    .catch((err) => console.error('MathJax global typeset failed:', err));
                            }
                        }, 100);
                    })
                    .catch(err => console.error("Error loading question detail:", err));
            }
        }

        function showListView() {
            const listSection = document.getElementById('question-list-view');
            const detailSection = document.getElementById('question-detail-view');
            const detailContent = document.getElementById('detail-content-area');

            if (listSection && detailSection) {
                detailSection.style.display = 'none';
                listSection.style.display = 'block';
                detailContent.innerHTML = '';
            }
        }

        function deleteAttempt(attemptId) {
            if (!confirm('ì •ë§ ì´ ì‹œí—˜ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            const baseUrl = "{% url 'mypage:delete_attempt' 0 %}";
            const url = baseUrl.replace('0', attemptId);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Reload history list - use the same AJAX logic as clicking the tab
                        document.querySelector('.menu-item[onclick="showSection(\'history\')"]').click();
                    } else {
                        alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
                    }
                })
                .catch(err => {
                    console.error('Delete Error:', err);
                    alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
    </script>
</body>

</html>
```